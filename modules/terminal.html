<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ROOT TERMINAL</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        body { background: #000; font-family: 'Courier New', Courier, monospace; overflow: hidden; display: flex; flex-direction: column; }
        #console-container { 
            flex-grow: 1; padding: 20px; overflow-y: auto; 
            scrollbar-width: none; /* Firefox */
        }
        #console-container::-webkit-scrollbar { display: none; } /* Chrome */
        
        .line { color: #00ff41; font-size: 14px; line-height: 1.5; white-space: pre-wrap; margin-bottom: 5px; }
        .line.error { color: #ff3333; }
        .line.system { color: #888; }
        .line.gold { color: gold; font-weight: bold; }
        
        .input-line { display: flex; padding: 0 20px 20px 20px; align-items: center; }
        .prompt { color: #00ff41; margin-right: 10px; font-weight: bold; }
        input {
            background: transparent; border: none; color: #fff; font-family: inherit; font-size: 14px;
            width: 100%; outline: none; caret-color: #00ff41;
        }
    </style>
</head>
<body>
    <div id="console-container">
        <div class="line">OMEGA LINUX v.10.4 [ROOT ACCESS]</div>
        <div class="line">WARNING: UNAUTHORIZED SECTORS DETECTED.</div>
        <div class="line system">Scanning file system...</div>
        <div class="line system">Found 1 encrypted partition: [SECTOR_SIGMA]</div>
        <div class="line">Type 'help' for commands.</div>
        <br>
    </div>

    <div class="input-line">
        <span class="prompt" id="prompt-text">tigranes@omega:~$</span>
        <input type="text" id="cmd" autofocus autocomplete="off">
    </div>

    <script src="../assets/js/main.js"></script>
    <script>
        const consoleDiv = document.getElementById('console-container');
        const input = document.getElementById('cmd');
        const promptText = document.getElementById('prompt-text');
        
        let isUnlocked = false; // Статус взлома

        // Обработка ввода
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const command = this.value.trim();
                printLine(`${promptText.innerText} ${this.value}`, 'system');
                if (command) processCommand(command);
                this.value = '';
                scrollToBottom();
            }
        });

        document.body.onclick = () => input.focus();

        function printLine(text, type = '') {
            const div = document.createElement('div');
            div.className = `line ${type}`;
            div.innerText = text;
            consoleDiv.appendChild(div);
            // Звук печати из main.js
            if(window.parent.soundType) window.parent.soundType(); 
        }

        function scrollToBottom() {
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function processCommand(cmdStr) {
            const args = cmdStr.split(' ');
            const cmd = args[0].toLowerCase();
            const arg1 = args[1];

            // Простые звуки
            if(window.parent.soundClick) window.parent.soundClick();

            switch(cmd) {
                case 'help':
                    printLine("COMMANDS:\n  ls         - List files\n  unlock     - Decrypt secured folders\n  run        - Execute programs\n  whoami     - User info\n  clear      - Clear screen");
                    break;

                case 'ls':
                    printLine("FILES:");
                    printLine("  readme.txt");
                    printLine("  passwords.log");
                    if(!isUnlocked) {
                        printLine("  [SECTOR_SIGMA] (LOCKED - REQUIRES PASSCODE)", "error");
                    } else {
                        printLine("  [SECTOR_SIGMA] (OPEN)", "gold");
                        printLine("    └── run_sigma.exe", "gold");
                    }
                    break;

                case 'unlock':
                    if(isUnlocked) {
                        printLine("Sector already decrypted.", "system");
                        break;
                    }
                    printLine("ENTER SECURITY OVERRIDE CODE (Hint: Check Evidence Locker):");
                    
                    // Хак для смены режима ввода на "ожидание пароля"
                    // В реальном терминале сложнее, тут сделаем просто проверку следующей команды
                    input.placeholder = "ENTER PASSCODE...";
                    input.onkeydown = function(e) {
                        if(e.key === 'Enter') {
                            const pass = this.value.trim().toUpperCase();
                            printLine(`> ************`, 'system');
                            
                            // ПРОВЕРКА ПАРОЛЯ ИЗ EVIDENCE.HTML
                            if(pass === 'TIG_GENESIS') {
                                isUnlocked = true;
                                if(window.parent.soundClick) window.parent.soundClick(); // Успех
                                printLine("ACCESS GRANTED.", "gold");
                                printLine("DECRYPTING SECTOR_SIGMA... 100%", "gold");
                                printLine("NEW BINARY FOUND: run_sigma.exe", "gold");
                            } else {
                                if(window.parent.soundDeny) window.parent.soundDeny(); // Ошибка
                                printLine("ACCESS DENIED. INCORRECT PASSCODE.", "error");
                            }
                            
                            // Сброс
                            this.value = '';
                            this.placeholder = "";
                            this.onkeydown = null; // Убираем перехват
                            // Возвращаем старый листенер (он на самом деле остался на элементе, просто мы перебивали событие. 
                            // Чтобы было чисто, перезагрузим страницу или просто вернем логику processCommand в след раз.
                            // Для простоты здесь: перезагрузим страницу фрейма или оставим как есть, так как старый листенер сработает тоже.
                            // Лучший фикс: reload listeners logic. Но проще просто не перехватывать так глубоко.
                        }
                    };
                    return; // Прерываем стандартный цикл, ждем пароль во втором листере
                    break;

                case 'run':
                case './run_sigma.exe':
                case 'run_sigma.exe':
                    if(!isUnlocked) {
                        printLine("ERROR: File not found or locked.", "error");
                    } else {
                        printLine("EXECUTING SIGMA PROTOCOL...", "gold");
                        printLine("GOODBYE, ARCHITECT.", "gold");
                        setTimeout(() => {
                            window.location.href = "sigma.html";
                        }, 2000);
                    }
                    break;
                
                case 'whoami':
                    printLine("User: TIGRANES (Level 10 Admin)");
                    break;
                
                case 'clear':
                    consoleDiv.innerHTML = '';
                    break;

                default:
                    printLine(`Command '${cmd}' not found.`, 'error');
            }
        }
        
        // Фикс конфликта листенеров для пароля
        // (Для упрощения я оставил базовую логику. Если ввести unlock, следующий ввод в input сработает в обоих листенерах.
        // Это баг вайб-кодинга. Исправляем: )
        
        // УДАЛЯЕМ СТАРЫЙ ЛИСТЕНЕР и ПИШЕМ НОВЫЙ ЧИСТЫЙ:
        const oldInput = input.cloneNode(true);
        input.parentNode.replaceChild(oldInput, input);
        const newInput = document.getElementById('cmd');
        
        let inputMode = 'cmd'; // 'cmd' or 'pass'

        newInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.trim();
                this.value = '';

                if(inputMode === 'pass') {
                    printLine(`> ************`, 'system');
                    if(val.toUpperCase() === 'TIG_GENESIS') {
                        isUnlocked = true;
                        printLine("ACCESS GRANTED. SECTOR SIGMA OPEN.", "gold");
                        printLine("Try: 'run sigma'", "system");
                        if(window.parent.soundClick) window.parent.soundClick();
                    } else {
                        printLine("ACCESS DENIED.", "error");
                        if(window.parent.soundDeny) window.parent.soundDeny();
                    }
                    inputMode = 'cmd';
                    promptText.style.display = 'inline';
                    newInput.placeholder = "";
                } else {
                    printLine(`${promptText.innerText} ${val}`, 'system');
                    if(val) runCmd(val);
                }
                scrollToBottom();
            }
        });
        
        function runCmd(cmdStr) {
            const args = cmdStr.split(' ');
            const cmd = args[0].toLowerCase();
            
            if(cmd === 'unlock') {
                if(isUnlocked) { printLine("Already unlocked."); return; }
                printLine("ENTER PASSWORD:", "gold");
                inputMode = 'pass';
                promptText.style.display = 'none';
                newInput.placeholder = "PASSWORD REQUIRED";
                newInput.focus();
                return;
            }
            
            if(cmd === 'run' && args[1] === 'sigma') {
                if(!isUnlocked) { printLine("LOCKED.", "error"); return; }
                window.location.href = "sigma.html";
                return;
            }

            // Дублируем логику (ls, help, etc)
            if(cmd === 'ls') {
                printLine(isUnlocked ? "SECTOR_SIGMA [OPEN]" : "SECTOR_SIGMA [LOCKED]", isUnlocked ? "gold" : "error");
            } else if (cmd === 'help') {
                printLine("ls, unlock, run sigma, clear");
            } else if (cmd === 'clear') {
                consoleDiv.innerHTML = '';
            } else {
                printLine("Unknown command.");
            }
        }

    </script>
</body>
</html>